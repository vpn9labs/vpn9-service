// ------------------------------------------------------------
// VPN9 Protocol
// ------------------------------------------------------------

// This file contains the protocol definitions for the VPN9 system.
// It is used to define the messages that are sent between the
// control plane and the agents. Agents are responsible for
// the Wireguard VPN service.

syntax = "proto3";
package VPN9;

// ------------------------------------------------------------
// Control Plane
// ------------------------------------------------------------

// Control Plane is the central hub for managing agents that
// run on Point of Presence (PoP) servers.

service ControlPlane {
  rpc SubscribeAgent(AgentSubscriptionRequest) returns (stream AgentSubscriptionMessage) {}
  rpc ReportHealth(HealthResponse) returns (HealthAck) {}
}

// ------------------------------------------------------------
// Agent Registration
// ------------------------------------------------------------

message AgentRegistration {
  string status = 1;
  string wg_public_key = 2;
  string wg_private_key = 3; // Base64 X25519 private key (sent to agent)
  uint32 wg_listen_port = 4;
  string wg_interface_ipv4 = 5;
  string wg_interface_ipv6 = 6;
}

// ------------------------------------------------------------
// Agent Subscription
// ------------------------------------------------------------

message AgentSubscriptionRequest {
  string agent_id = 1;
  string hostname = 2;
  string os_version = 3;
  string kernel_version = 4;
  string public_ip = 5;
  int32 cpu_count = 6;
  int32 total_memory_mb = 7;
  string wg_public_key = 8; // Agent-generated public key
}

message PeerAdd {
  string agent_id = 1;
  string public_key = 2;
  // Explicit allowed IPs for the peer (can include IPv4 and IPv6 CIDRs)
  repeated string allowed_ips = 3;
  // Device IPv6 address (informational; allowed_ips should be the source of truth)
  string ipv6 = 4;
  reserved 5, 6;
}

// Request to remove a previously registered peer
message PeerRemove {
  string agent_id = 1;
  string public_key = 2;
  reserved 3;
}

message HealthCheck {
  string agent_id = 1;
  int64 timestamp = 2;
}

message HealthResponse {
  string agent_id = 1;
  int64 timestamp = 2;
  string status = 3;
}

message HealthAck {
  bool accepted = 1;
}

message AgentDisconnect {
  string agent_id = 1;
  string reason = 2;
}

message AgentSubscriptionMessage {
  string agent_id = 1;
  oneof message {
    AgentRegistration agent_registration = 2;
    PeerAdd peer_add = 3;
    PeerRemove peer_remove = 7;
    HealthCheck health_check = 4;
    HealthResponse health_response = 5;
    AgentDisconnect agent_disconnect = 6;
  }
}

// (Update RPCs removed; agent auto-update disabled)
